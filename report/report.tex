\documentclass[a4paper,12pt]{article}
\usepackage[utf8x]{inputenc}
\usepackage[LGR]{fontenc}
\usepackage{ucs}

\usepackage{polyglossia}
%\setdefaultlanguage{greek}

\usepackage{listings}
\usepackage{textcomp}

\setmainfont{Times New Roman}
\setsansfont{Arial}
\newfontfamily\greekfont{Times New Roman}
\setmainfont[Script=Greek]{Times New Roman}



\DeclareGraphicsExtensions{.pdf, .jpg}


%----------------------------------------------------------------------------------------
%	LISTINGS (CODE) TEMPLATE
%----------------------------------------------------------------------------------------

\lstset
{
	keywordstyle=\bfseries\ttfamily\color[rgb]{0,0,1},
	identifierstyle=\ttfamily,
	commentstyle=\color[rgb]{0.133,0.545,0.133},
	stringstyle=\ttfamily\color[rgb]{0.627,0.126,0.941},
	showstringspaces=false,
	basicstyle=\small,
	numberstyle=\footnotesize,
	numbers=left,
	stepnumber=1,
	numbersep=10pt,
	tabsize=2,
	breaklines=true,
	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
	breakatwhitespace=false,
	aboveskip={1.5\baselineskip},
  	columns=fixed,
  	upquote=true,
  	extendedchars=true,
	frame=single
	inputencoding=utf8
}

\begin{document}

\begin{titlepage}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} 

\center
 
%----------------------------------------------------------------------------------------
%	HEADING SECTION
%----------------------------------------------------------------------------------------

\textsc{\LARGE Εθνικό Μετσόβιο Πολυτεχνείο}\\[1.5cm] % Name of your university/college
\textsc{\Large Βάσεις Δεδομένων}\\[0.5cm] % Major heading such as course name


%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\HRule \\[0.4cm]
{ \huge \bfseries Αναφορά Εξαμηνιαίο Project 2013-2014  }\\[0.4cm]
\HRule \\[1.5cm]
 
%----------------------------------------------------------------------------------------
%	LOGO SECTION
%----------------------------------------------------------------------------------------

\includegraphics[scale=0.5]{ntua_logo} 
 
%----------------------------------------------------------------------------------------
%	AUTHOR SECTION
%----------------------------------------------------------------------------------------
\vfill

Ηλίας Φωτόπουλος \\ 03109106\\
Θανάσης Βράτιμος \\03110769


%----------------------------------------------------------------------------------------

\end{titlepage}

\section{Λεπτομέρειες Υλοποίησης}
Για την κατασκευή του project έγινε χρήση των παρακάτω τεχνολογιών:
\begin{itemize}
  \item Ruby on Rails (Framework)
  \item HTML \ Sass (Syntactically Awesome Style Sheets) 
  \item Bootstrap (Sass Framework)
  \item CoffeeScript
  \item Git (Version Control)
\end{itemize}

Κατά την φάση του σχεδιασμού αποφασίστηκε η χρήση του RoR framework λόγω της αρχιτεκτονικής MVC που ακολουθεί αλλά και λόγω της φιλοσοφίας του Convention over Configuration (CoC) και Don't Repeat Yourself (DRY).

\section{Views}
Δημιουργήσαμε τα παρακάτω δύο views.
Το view upcoming reservations περιέχει όλες τις κρατήσεις για τις οποίες η μέρα άφιξης είναι μεταγενέστερη της σημερινής μέρας. Επίσης εκτελεί inner join, με τα tables: clients,hotels,rooms έτσι ώστε να εμφανίσει όνομα πελάτη, ξενοδοχείου αλλά και τον τύπο του δωματίου. Η χρησιμότητα του view είναι η παρουσίαση όλων των κρατήσεων για τις οποίες ο πελάτης δεν έχει φτάσει ακόμη.

\begin{lstlisting}[language=SQL]
CREATE OR REPLACE VIEW upcoming_reservations AS
SELECT reservations.id, reservations.arrival_date, reservations.departure_date, reservations.created_at, reservations.updated_at, clients.first_name, clients.last_name, hotels.name, rooms.room_type
FROM reservations
INNER JOIN clients
ON reservations.client_id = clients.id
INNER JOIN hotels
ON reservations.hotel_id = hotels.id
INNER JOIN rooms
ON reservations.room_id = rooms.id
WHERE arrival_date > CURDATE()
ORDER BY arrival_date
\end{lstlisting}

Το view upcoming reservations updatable επιτελεί τις ίδιες λειτουργίες με το παραπάνω με δύο βασικές διαφορές:
\begin{itemize}
  \item Δεν χρησιμοποιεί inner join για να πάρει τα names από τα άλλα tables.
  \item Περιέχει κρατήσεις όπου η μέρα αναχώρησης (όχι άφιξης) είναι μεταγενέστερη της σημερινής
\end{itemize}
Το εν λόγω view παίζει σημαντικό ρόλο στην εσωτερική αρχιτεκτονική και λογική της εφαρμογής μας. Χρησιμοποιείται από το ReservationService το οποίο ελέγχει αν ένα δωμάτιο είναι διαθέσιμο για κράτηση.

\begin{lstlisting}[language=SQL]
CREATE OR REPLACE VIEW upcoming_reservations_updatable AS
SELECT *
FROM reservations
WHERE departure_date > CURDATE()
ORDER BY arrival_date
\end{lstlisting}

\section{Triggers}
Δημιουργήσαμε τα παρακάτω δύο triggers.\\
To trigger delete hotel rooms, το οποίο πριν διαγράψει ένα ξενοδοχείο διαγράφει και όλα τα δωμάτια του. Τα δωμάτια ανήκουν στο  αδύναμο σύνολο οντοτήτων "Δωμάτιο" και εξαρτιούνται πλήρως από το ξενοδοχείο στο οποίο ανήκουν, οπότε και δεν έχει νόημα να υφίστανται αν διαγραφεί το ξενοδοχείο τους.

\begin{lstlisting}[language=SQL]
CREATE TRIGGER delete_hotel_rooms
BEFORE DELETE ON hotels 
FOR EACH ROW
BEGIN
	DELETE FROM rooms WHERE OLD.id = hotel_id;
END
\end{lstlisting}

Παρομοίως με παραπάνω δημιουργήσαμε ένα trigger που διαγράφει όλες τις κρατήσεις ενός πελάτη πριν διαγραφεί ο πελάτης.

\begin{lstlisting}[language=SQL]
CREATE TRIGGER delete_client_reservations
BEFORE DELETE ON clients 
FOR EACH ROW
BEGIN
	DELETE FROM reservations WHERE OLD.id = client_id;
END
\end{lstlisting}

Στο σημείο αυτό αξίζει να αναφερθεί ότι το παραπάνω θα μπορούσε να υλοποιηθεί εύκολα και μέσα από το περιβάλλον του RoR Framework (χρήση Rails ActiveRecord callbacks). Αρκεί να προστεθούν τα παρακάτω στα μοντέλα hotel και client αντίστοιχα.

\begin{lstlisting}[language=Ruby]
has_many :rooms, dependent: :destroy
\end{lstlisting}

\begin{lstlisting}[language=Ruby]
has_many :reservations, dependent: :destroy
\end{lstlisting}

\subsection{Callback vs Trigger}
	\textbf{Πλεονεκτήματα Callback:}
	\begin{itemize}
	  \item Όλη η Business Logic του μοντέλου βρίσκεται στην Rails κάτι το οποίο κάνει πιο εύκολη την συντήρηση και ανάπτυξη του.
	  \item Εύκολο Debug
	  \item Ο κώδικας Ruby γράφετε και διαβάζεται πιο εύκολα
	  \item Η εφαρμογή μας δεν εξαρτάται από την υλοποίηση (και συντακτικό) της βάσης δεδομένων.
	\end{itemize}
	\textbf{Πλεονεκτήματα Trigger:}
	\begin{itemize}
	  \item Είναι πιο γρήγορο από ένα callback. (Στο callback χρειάζεται να συνδεθείς στην βάση δεδομένων, ενώ στο trigger είσαι ήδη στο layer της βάσης δεδομένων)
	\end{itemize}
	Βάση των παραπάνω και δεδομένου το μέγεθος της εφαρμογής το ιδανικό θα ήταν να γίνει χρήση Rails ActiveRecord callbacks.


\end{document}
